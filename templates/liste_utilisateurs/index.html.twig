{% extends 'base.html.twig' %}

{% block title %}{{ 'users_list.title'|trans }}{% endblock %}

{% block body %}
<div class="min-h-screen w-screen bg-cover bg-center bg-no-repeat bg-local"
     style="background-image: url('{{ asset('images/blob-scatter-haikei.svg') }}');">

  <div class="min-h-screen w-screen bg-black/30">
    <div class="mx-auto max-w-6xl px-6 py-12">

    {% if is_granted('ROLE_ORGANISATEUR') %}

      <div class="mb-10 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h1 class="text-3xl font-bold text-white">{{ 'users_list.heading'|trans }}</h1>
          <p class="mt-1 text-sm text-white/80">
            {{ 'users_list.subheading'|trans }}
          </p>
        </div>

        <div class="inline-flex items-center rounded-full bg-white/15 px-4 py-2 text-xs font-semibold text-white ring-1 ring-white/15">
          {{ 'users_list.total'|trans({'%total%': total}) }}
        </div>
      </div>

      <form method="get" action="{{ path('app_liste_utilisateurs') }}" class="max-w-2xl mx-auto mb-6">
        <div class="flex shadow-xs rounded-xl overflow-hidden">
          <label for="field" class="sr-only">{{ 'users_list.search.field_label'|trans }}</label>
          <select
            id="field"
            name="field"
            class="inline-flex items-center shrink-0 z-10 text-body bg-neutral-secondary-medium
                  box-border border border-default-medium hover:bg-neutral-tertiary-medium hover:text-heading
                  focus:ring-4 focus:ring-neutral-tertiary font-medium leading-5 rounded-s-base text-sm
                  px-4 py-2.5 focus:outline-none"
          >
            <option value="all" {{ (field ?? 'all') == 'all' ? 'selected' : '' }}>{{ 'users_list.search.fields.all'|trans }}</option>
            <option value="nom" {{ (field ?? '') == 'nom' ? 'selected' : '' }}>{{ 'users_list.search.fields.lastname'|trans }}</option>
            <option value="prenom" {{ (field ?? '') == 'prenom' ? 'selected' : '' }}>{{ 'users_list.search.fields.firstname'|trans }}</option>
            <option value="email" {{ (field ?? '') == 'email' ? 'selected' : '' }}>{{ 'users_list.search.fields.email'|trans }}</option>
          </select>

          <label for="q" class="sr-only">{{ 'users_list.search.label'|trans }}</label>
          <input
            type="search"
            id="q"
            name="q"
            value="{{ q ?? '' }}"
            class="px-3 py-2.5 bg-neutral-secondary-medium border border-default-medium text-heading text-sm
                  focus:ring-brand focus:border-brand block w-full placeholder:text-body"
            placeholder="{{ 'users_list.search.placeholder'|trans }}"
          >

          <button
            type="submit"
            class="inline-flex items-center text-white
                  bg-emerald-600 hover:bg-emerald-700
                  box-border border border-transparent
                  focus:ring-4 focus:ring-white/40
                  shadow-xs font-medium leading-5
                  rounded-e-base text-sm px-4 py-2.5
                  focus:outline-none transition"
          >
            <svg class="w-4 h-4 me-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
              <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="m21 21-3.5-3.5M17 10a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z"/>
            </svg>
            {{ 'users_list.search.button'|trans }}
          </button>
        </div>
      </form>

      <div class="space-y-4">
        {% for u in utilisateurs %}
          <div class="utilisateur rounded-2xl bg-white/90 p-5 shadow-lg ring-1 ring-black/5 backdrop-blur opacity-0 translate-x-10 transition-all duration-300 ease-in-out">
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">

              <div class="flex items-center gap-4">
                <img
                  class="h-14 w-14 rounded-full bg-slate-100 ring-1 ring-black/10 object-cover"
                  src="{{ u.photoUrl ?? ('https://api.dicebear.com/9.x/thumbs/svg?seed=' ~ u.email) }}"
                  alt="Photo de {{ u.prenom }} {{ u.nom }}"
                  loading="lazy"
                />

                <div>
                  <div class="text-base font-semibold text-slate-900">
                    {{ u.nom }} {{ u.prenom }}
                  </div>
                  <div class="text-sm text-slate-600">
                    {{ u.email }}
                  </div>
                </div>
              </div>

              <div class="flex items-center gap-3">
                <a href="{{ path('app_orga_reinitialiser_motdepasse', { id: u.id }) }}"
                   class="inline-flex items-center justify-center rounded-xl bg-red-600 px-5 py-3 text-sm font-semibold text-white hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-600/20 transition"
                   onclick="return confirm('{{ 'users_list.actions.confirm_reset'|trans|escape('js') }}')">
                  {{ 'users_list.actions.reset_password'|trans }}
                </a>

                <form method="post" action="{{ path('app_changer_utilisateur', {'_switch_user': u.email}) }}">
                  <button
                    type="submit"
                    class="inline-flex items-center justify-center rounded-xl bg-emerald-600 px-5 py-3 text-sm font-semibold text-white
                          hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-600/20 transition"
                  >
                    {{ 'users_list.actions.impersonate'|trans }}
                  </button>
                </form>

                <form method="post" action="{{ path('app_rendre_organisateur', { id: u.id, q: q, field: field, page: page }) }}">
                  <input type="hidden" name="_token" value="{{ csrf_token('promote_user_' ~ u.id) }}">
                  <button
                    type="submit"
                    class="inline-flex items-center justify-center rounded-xl bg-emerald-600 px-5 py-3 text-sm font-semibold text-white
                          hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-600/20 transition"
                    onclick="return confirm('{{ 'users_list.actions.confirm_promote'|trans|escape('js') }}')"
                  >
                    {{ 'users_list.actions.promote'|trans }}
                  </button>
                </form>
              </div>

            </div>
          </div>
        {% else %}
          <div class="rounded-2xl bg-white/90 p-8 text-center shadow-lg ring-1 ring-black/5 backdrop-blur">
            <p class="text-lg font-semibold text-slate-900">{{ 'users_list.empty.title'|trans }}</p>
            <p class="mt-2 text-sm text-slate-600">{{ 'users_list.empty.message'|trans }}</p>
          </div>
        {% endfor %}
      </div>

      {% if pages > 1 %}
        <nav class="mt-8 flex items-center justify-center" aria-label="Pagination">
          <ul class="inline-flex mb-6 items-center gap-2 text-sm">

            <li>
              <a
                href="{{ path('app_liste_utilisateurs', { page: page > 1 ? page - 1 : 1 }) }}"
                class="inline-flex items-center justify-center gap-2 rounded-xl px-4 h-10 font-semibold
                       ring-1 ring-black/10 backdrop-blur
                       {{ page <= 1
                         ? 'pointer-events-none opacity-40 bg-white/60 text-slate-700'
                         : 'bg-white/80 text-slate-800 hover:bg-white hover:text-slate-900' }}"
                aria-disabled="{{ page <= 1 ? 'true' : 'false' }}"
              >
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                {{ 'users_list.pagination.previous'|trans }}
              </a>
            </li>
            {% set start = (page - 2) < 1 ? 1 : page - 2 %}
            {% set end = (start + 4) > pages ? pages : start + 4 %}
            
            {% for p in start..end %}
              <li>
                <a
                  href="{{ path('app_liste_utilisateurs', { page: p, q: q, field: field }) }}"
                  aria-current="{{ p == page ? 'page' : 'false' }}"
                  class="inline-flex items-center justify-center w-10 h-10 rounded-xl font-semibold ring-1 ring-black/10 transition
                         {{ p == page
                            ? 'bg-emerald-600 text-white ring-emerald-600/30 shadow-sm'
                            : 'bg-white/70 text-slate-800 hover:bg-white' }}"
                >
                  {{ p }}
                </a>
              </li>
            {% endfor %}

            <li>
              <a
                href="{{ path('app_liste_utilisateurs', { page: page < pages ? page + 1 : pages }) }}"
                class="inline-flex items-center justify-center gap-2 rounded-xl px-4 h-10 font-semibold
                       ring-1 ring-black/10 backdrop-blur
                       {{ page >= pages
                         ? 'pointer-events-none opacity-40 bg-white/60 text-slate-700'
                         : 'bg-white/80 text-slate-800 hover:bg-white hover:text-slate-900' }}"
                aria-disabled="{{ page >= pages ? 'true' : 'false' }}"
              >
                {{ 'users_list.pagination.next'|trans }}
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            </li>

          </ul>
        </nav>
      {% endif %}

    {% else %}
      <div class="rounded-2xl bg-white/85 p-8 text-center shadow-lg ring-1 ring-black/5 backdrop-blur">
        <p class="text-lg font-semibold text-slate-900">{{ 'users_list.error.access_denied_title'|trans }}</p>
        <p class="mt-2 text-sm text-slate-600">{{ 'users_list.error.access_denied_subtitle'|trans }}</p>
      </div>
    {% endif %}

    </div>
  </div>
</div>

<script>
const observateur = new IntersectionObserver((entries) => {
  entries.forEach((entry) => {
    if (entry.isIntersecting) {
      entry.target.classList.remove("opacity-0", "translate-x-10");
      entry.target.classList.add("opacity-100", "translate-x-0");
    } else {
      entry.target.classList.remove("opacity-100", "translate-x-0");
      entry.target.classList.add("opacity-0");
    }
  });
}, {threshold : 0.1});

document.querySelectorAll(".utilisateur").forEach(el => { observateur.observe(el) });
</script>
{% endblock %}