{% extends 'base.html.twig' %}

{% block title %}{{ 'team_registration.title'|trans }}
{% endblock %}

{% block body %}
	<div class="relative h-screen w-screen overflow-hidden">

		<img src="{{ asset('images/ImageInscription.png') }}" alt="" class="absolute inset-0 w-full h-full object-cover blur-lg scale-110"/>

		<div class="absolute inset-0 bg-black/30"></div>

		<div class="relative z-10 h-full flex items-center justify-center px-6">
			<div class="w-full max-w-md px-10 py-10 bg-[#9ECFC2]/90 backdrop-blur-xl rounded-2xl shadow-2xl">

				<h1 class="mb-10 text-4xl md:text-5xl font-semibold text-white text-center">
					{{ 'team_registration.heading'|trans }}
				</h1>

				{% if is_granted('ROLE_USER') %}

					{% for label, messages in app.flashes %}
						{% for message in messages %}
							<div class="alert alert-{{ label == 'danger' ? 'danger' : 'success' }} p-4 mb-4 rounded border shadow-sm">
								<strong>{{ label == 'danger' ? 'flash.error'|trans : 'flash.success'|trans }}</strong>
								{{ message }}
							</div>
						{% endfor %}
					{% endfor %}

					{{ form_start(FormulaireInscriptionEquipe, {'attr': {'class': 'max-w-md mx-auto'}}) }}

					<div class="relative z-0 w-full mb-6 group">
						{{ form_widget(FormulaireInscriptionEquipe.nom, {
          'attr': {
            'class': 'block py-2.5 px-0 w-full text-sm text-black bg-transparent border-0 border-b-2 border-black/30 appearance-none focus:outline-none focus:ring-0 focus:border-[#07b98e] peer',
            'placeholder': ' '
          }
        }) }}
						{{ form_label(FormulaireInscriptionEquipe.nom, 'team_registration.label.team_name'|trans, 
 {
          'label_attr': {
            'class': 'absolute text-sm text-black/70 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:text-[#07b98e] peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6'
          }
        }) }}
						{{ form_errors(FormulaireInscriptionEquipe.nom) }}
					</div>

					<div class="relative z-0 w-full mb-8 group">
						{{ form_widget(FormulaireInscriptionEquipe.etablissement, {
          'attr': {
            'class': 'block py-2.5 px-0 w-full text-sm text-black bg-transparent border-0 border-b-2 border-black/30 
 appearance-none focus:outline-none focus:ring-0 focus:border-[#07b98e] peer',
            'placeholder': ' '
          }
        }) }}
						{{ form_label(FormulaireInscriptionEquipe.etablissement, 'team_registration.label.establishment'|trans, {
          'label_attr': {
            'class': 'absolute text-sm text-black/70 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:text-[#07b98e] peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6'
          }
        }) }}
						{{ form_errors(FormulaireInscriptionEquipe.etablissement) }}
					</div>

					<div 
 class="hidden">
						{{ form_widget(FormulaireInscriptionEquipe.membres, {'attr': {'id': 'equipe_membres_hidden'}}) }}
						{{ form_errors(FormulaireInscriptionEquipe.membres) }}
					</div>

					<button type="button" data-modal-target="membresModal" data-modal-toggle="membresModal" class="w-full mb-4 text-white bg-white/20 hover:bg-white/30 focus:ring-4 focus:ring-white/40 font-medium rounded-xl text-sm px-4 py-3 focus:outline-none transition">
						+ {{ 'team_registration.button.add_members_modal'|trans }}
					</button>

					<button type="submit" class="w-full text-white bg-[#07b98e] hover:bg-[#059e79] focus:ring-4 focus:ring-white/40 font-medium rounded-xl text-sm px-4 py-3 focus:outline-none transition">
						{{ 'team_registration.button.submit'|trans }}
					</button>

					{{ form_end(FormulaireInscriptionEquipe) }}

				{% else %}
					<p class="text-center text-white text-lg">
						{{ 'team_registration.error.access_denied'|trans }}
					</p>
				{% endif %}
			</div>
		</div>
	</div>

	<div id="membresModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">

		<div class="relative p-4 w-full max-w-3xl max-h-full">

			<div class="relative bg-white rounded-2xl shadow">

				<div class="flex items-start justify-between p-4 border-b rounded-t">
					<div>
						<h3 class="text-lg font-semibold text-gray-900">{{ 'team_registration.modal.title'|trans }}</h3>
						<p class="text-sm text-gray-500">{{ 'team_registration.modal.subtitle'|trans }}</p>
					</div>

					<button type="button" class="text-gray-400 bg-transparent hover:bg-gray-100 hover:text-gray-900 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center" data-modal-hide="membresModal">
						<svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 14 14">
							<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 12 12M13 1 1 13"/>
						</svg>
						<span class="sr-only">{{ 'team_registration.modal.close'|trans }}</span>
					</button>
				</div>

				<div class="p-4">
					<div class="grid grid-cols-1 gap-4 md:grid-cols-5">

						<div class="md:col-span-3">
							<div class="grid grid-cols-1 gap-3">
								<div>
									<label class="block text-sm font-medium text-gray-700">{{ 'team_registration.modal.label.email'|trans }}</label>
									<input id="m_email" type="email" class="mt-1 w-full rounded-xl border-gray-300 focus:border-emerald-500 focus:ring-emerald-500" placeholder="{{ 'team_registration.modal.placeholder.email'|trans }}">
								</div>

								<div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
									<div>
										<label class="block text-sm font-medium text-gray-700">{{ 'team_registration.modal.label.firstname'|trans }}</label>
										<input id="m_prenom" type="text" class="mt-1 w-full rounded-xl border-gray-300 focus:border-emerald-500 focus:ring-emerald-500" placeholder="{{ 'team_registration.modal.placeholder.firstname'|trans }}">
									</div>

									<div>
										<label class="block text-sm font-medium text-gray-700">{{ 'team_registration.modal.label.lastname'|trans }}</label>
										<input id="m_nom" type="text" class="mt-1 w-full rounded-xl border-gray-300 focus:border-emerald-500 focus:ring-emerald-500" placeholder="{{ 'team_registration.modal.placeholder.lastname'|trans }}">
									</div>
								</div>

								<button id="btn_add_member" type="button" class="mt-2 inline-flex items-center justify-center rounded-xl bg-emerald-600 px-4 py-2 text-sm 
 font-semibold text-white hover:bg-emerald-700">
									{{ 'team_registration.modal.button.add'|trans }}
								</button>

								<p id="m_error" class="hidden text-sm text-red-600"></p>
							</div>
						</div>

						<div class="md:col-span-2">
							<div class="rounded-2xl border bg-gray-50 p-3">
								<div class="flex items-center justify-between">
									<div class="text-sm font-semibold text-gray-900">{{ 'team_registration.modal.list_title'|trans }}</div>
									<div class="text-xs text-gray-500">
										<span id="count_members">0</span>
									</div>
								</div>

								<div id="members_list" class="mt-3 space-y-2">
									<div id="empty_members" class="text-sm text-gray-500">
										{{ 'team_registration.modal.empty_list'|trans }}
 </div>
								</div>
							</div>
						</div>

					</div>
				</div>

				<div class="flex items-center justify-end gap-2 p-4 border-t rounded-b">
					<button type="button" class="rounded-xl bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-200" data-modal-hide="membresModal">
						{{ 'team_registration.modal.button.cancel'|trans }}
					</button>

					<button id="btn_finalize_members" type="button" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700" data-modal-hide="membresModal">
						{{ 'team_registration.modal.button.finalize'|trans }}
					</button>
				</div>

			</div>
		</div>
	</div>

	 <script>
			  const members = [];
 const elHidden = document.getElementById('inscription_equipe_form_membres') || document.querySelector('input[id$="_membres"]');
			
			  const elEmail = document.getElementById('m_email');
			  const elPrenom = document.getElementById('m_prenom');
			  const elNom = document.getElementById('m_nom');
 const elError = document.getElementById('m_error');
			  const elList = document.getElementById('members_list');
			  const elEmpty = document.getElementById('empty_members');
			  const elCount = document.getElementById('count_members');
			  const btnAdd = document.getElementById('btn_add_member');
 function updateHiddenInput() {
			    if (elHidden) {
			      elHidden.value = JSON.stringify(members);
 console.log("JSON mis à jour :", elHidden.value); 
			    }
			  }
			
			  function showError(msg) {
			    elError.textContent = msg;
			    elError.classList.remove('hidden');
 }
			
			  function clearError() {
			    elError.textContent = '';
			    elError.classList.add('hidden');
 }
			
			  function validEmail(email) {
			    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
 }
			
			  function escapeHtml(str) {
			    return String(str).replace(/[&<>"']/g, s => ({
			      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
			    }[s]));
 }
			
			  function renderList() {
			    elCount.textContent = members.length;
			    
			    [...elList.querySelectorAll('[data-item]')].forEach(n => n.remove());
 if (members.length === 0) {
			      elEmpty.classList.remove('hidden');
			      return;
			    }
			
			    elEmpty.classList.add('hidden');
 members.forEach((m, idx) => {
			      const item = document.createElement('div');
			      item.setAttribute('data-item', '1');
			      item.className = "flex items-start justify-between gap-2 rounded-xl bg-white p-3 border mb-2";
			      item.innerHTML = `
			        <div class="flex items-start gap-2">
			          <div class="mt-0.5 h-5 w-5 rounded-md bg-emerald-600 text-white flex items-center justify-center text-xs font-bold">✓</div>
			          <div>
			            <div class="text-sm font-semibold 
 text-gray-900">${escapeHtml(m.prenom)} ${escapeHtml(m.nom)}</div>
			            <div class="text-xs text-gray-500">${escapeHtml(m.email)}</div>
			          </div>
			        </div>
			        <button type="button" class="text-xs font-semibold text-red-600 hover:underline" data-remove="${idx}">
			          {{ 'team_registration.modal.button.remove'|trans }}
			        </button>
			      `;
			      elList.appendChild(item);
			    });
 }
			
			  btnAdd.addEventListener('click', () => {
			    clearError();
			
			    const email = elEmail.value.trim();
			    const prenom = elPrenom.value.trim();
			    const nom = elNom.value.trim();
			
			    if (!email || !prenom || !nom) {
			      showError("{{ 'team_registration.modal.error.fill_all'|trans }}");
			      return;
			    }
			    if (!validEmail(email)) {
			      showError("{{ 'team_registration.modal.error.invalid_email'|trans }}");
			      return;
			    }
			    if (members.some(m => m.email.toLowerCase() === email.toLowerCase())) {
			    
   showError("{{ 'team_registration.modal.error.duplicate_email'|trans }}");
			      return;
			    }
			
			    members.push({ email, prenom, nom });
			
			    elEmail.value = '';
			    elPrenom.value = '';
			    elNom.value = '';
			
			    renderList();
			    updateHiddenInput();
			  });
 elList.addEventListener('click', (e) => {
			    const btn = e.target.closest('[data-remove]');
			    if (!btn) return;
			    
			    const idx = Number(btn.getAttribute('data-remove'));
			    members.splice(idx, 1);
			    
			    renderList();
			    updateHiddenInput();
			  });
 renderList();
			</script>
{% endblock %}