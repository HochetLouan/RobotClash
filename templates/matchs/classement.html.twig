{% extends 'base.html.twig' %}

{% block title %}{{ 'ranking.title'|trans }}{% endblock %}

{% block body %}
<div class="min-h-screen w-screen bg-cover bg-center bg-no-repeat bg-local"
     style="background-image: url('{{ asset('images/stacked-waves-haikei.svg') }}');">
  <div class="min-h-screen w-screen bg-black/30">
    <div class="mx-auto max-w-6xl px-6 py-12">

      <div class="mb-10 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h1 class="text-3xl font-bold text-white">{{ 'ranking.heading'|trans }}</h1>
          <p class="mt-1 text-sm text-white/80">{{ 'ranking.subheading'|trans }}</p>
        </div>
   
      <div class="inline-flex items-center rounded-full bg-white/15 px-4 py-2 text-xs font-semibold text-white ring-1 ring-white/15">
          {{ 'ranking.competition_id'|trans({'%id%': competitionId}) }}
        </div>
      </div>

      {% set classementSafe = classement|default({}) %}
      {% set keys = classementSafe|keys %}
      {% set topKeys = keys|slice(0, 3) %}

      {% set firstName  = topKeys[0]|default(null) %}
      {% set secondName = topKeys[1]|default(null) 
%}
      {% set thirdName  = topKeys[2]|default(null) %}

      {% set firstData  = firstName  ?
classementSafe[firstName]  : null %}
      {% set secondData = secondName ?
classementSafe[secondName] : null %}
      {% set thirdData  = thirdName  ?
classementSafe[thirdName]  : null %}

      <div id="podiumWrap" class="relative rounded-2xl bg-white/90 shadow-lg ring-1 ring-black/5 backdrop-blur overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200/70">
          <div class="text-sm font-semibold text-slate-900">{{ 'ranking.podium.title'|trans }}</div>
          <div class="text-xs text-slate-500">{{ 'ranking.podium.subtitle'|trans }}</div>
        </div>

       
        <canvas id="confettiCanvas" class="pointer-events-none absolute inset-0 w-full h-full opacity-0"></canvas>

        {% if keys|length == 0 
%}
          <div class="p-10 text-center">
            <div class="text-lg font-semibold text-slate-900">{{ 'ranking.empty.title'|trans }}</div>
            <div class="mt-2 text-sm text-slate-600">{{ 'ranking.empty.subtitle'|trans }}</div>
          </div>
        {% else %}
          <div class="p-6">
            <div class="grid grid-cols-1 gap-4 md:grid-cols-3 items-end">

  
             <div class="podium-card order-2 md:order-1">
                <div class="relative rounded-2xl bg-slate-50 ring-1 ring-slate-200 p-5 overflow-hidden">
                  <div class="absolute -top-10 -right-10 h-24 w-24 rounded-full bg-slate-200/60 blur-2xl"></div>

                  <div class="flex items-center justify-between">
               
      <span class="inline-flex items-center rounded-full bg-slate-900 px-2.5 py-1 text-[10px] font-extrabold text-white">#2</span>
                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-500">{{ 'ranking.podium.silver'|trans }}</span>
                  </div>

                  {% if secondName and secondData %}
                    
 <div class="mt-4 flex items-center gap-3">
                      <img class="h-12 w-12 rounded-full bg-white ring-1 ring-black/10 p-1"
                           src="https://api.dicebear.com/9.x/avataaars-neutral/svg?seed={{ secondName|url_encode }}"
                           alt="Avatar {{ secondName }}" loading="lazy">
       
                <div class="min-w-0">
                        <div class="font-extrabold text-slate-900 truncate">{{ secondName }}</div>
                        <div class="mt-0.5 text-xs text-slate-600">
                          <span class="font-semibold">{{ 
secondData.moyenne|default('-') }}</span> pts ‚Ä¢
                          {{ secondData.matchs|default('-') }} {{ 'ranking.table.matches'|trans|lower }}
                        </div>
                      </div>
                    </div>

  
                   <div class="mt-5 h-24 rounded-2xl bg-gradient-to-b from-slate-300 to-slate-400 shadow-inner podium-bar podium-bar-2"></div>
                  {% else %}
                    <div class="mt-4 text-sm text-slate-600">{{ 'ranking.podium.no_rank'|trans({'%rank%': 2}) }}</div>
                    <div class="mt-5 h-24 rounded-2xl bg-slate-200/80"></div>
    
               {% endif %}
                </div>
              </div>

              <div class="podium-card order-1 md:order-2">
                <div id="champCard" class="relative rounded-2xl bg-emerald-50 ring-1 ring-emerald-200 p-5 overflow-hidden">
             
      <div class="absolute -top-10 -left-10 h-28 w-28 rounded-full bg-emerald-300/40 blur-2xl"></div>

                  <div class="flex items-center justify-between">
                    <span class="inline-flex items-center rounded-full bg-emerald-700 px-2.5 py-1 text-[10px] font-extrabold text-white">#1</span>
                    <span class="text-[10px] font-bold uppercase tracking-wider text-emerald-800">{{ 'ranking.podium.champion'|trans }}</span>
            
       </div>

                  {% if firstName and firstData %}
                    <div class="mt-4 flex items-center gap-3">
                      <img class="h-12 w-12 rounded-full bg-white ring-1 ring-black/10 p-1"
                  
          src="https://api.dicebear.com/9.x/avataaars-neutral/svg?seed={{ firstName|url_encode }}"
                           alt="Avatar {{ firstName }}" loading="lazy">
                      <div class="min-w-0">
                        <div class="font-extrabold text-slate-900 truncate">{{ firstName }}</div>
      
                   <div class="mt-0.5 text-xs text-slate-600">
                          <span class="font-semibold">{{ firstData.moyenne|default('-') }}</span> pts ‚Ä¢
                          {{ firstData.matchs|default('-') }} {{ 'ranking.table.matches'|trans|lower }}
                   
      </div>
                      </div>

                      <div class="ml-auto hidden sm:flex items-center gap-2">
                        <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-emerald-700 text-white shadow trophy-badge">üèÜ</span>
            
       </div>
                    </div>

                    <div class="mt-5 h-32 rounded-2xl bg-gradient-to-b from-emerald-500 to-emerald-700 shadow-inner podium-bar podium-bar-1"></div>
                  {% else %}
                    <div 
 class="mt-4 text-sm text-slate-600">{{ 'ranking.podium.no_rank'|trans({'%rank%': 1}) }}</div>
                    <div class="mt-5 h-32 rounded-2xl bg-emerald-200/80"></div>
                  {% endif %}
                </div>
              </div>

              <div class="podium-card order-3">
      
           <div class="relative rounded-2xl bg-amber-50 ring-1 ring-amber-200 p-5 overflow-hidden">
                  <div class="absolute -bottom-10 -right-10 h-24 w-24 rounded-full bg-amber-200/60 blur-2xl"></div>

                  <div class="flex items-center justify-between">
                    <span class="inline-flex items-center rounded-full bg-amber-700 px-2.5 py-1 text-[10px] font-extrabold text-white">#3</span>
       
              <span class="text-[10px] font-bold uppercase tracking-wider text-amber-800">{{ 'ranking.podium.bronze'|trans }}</span>
                  </div>

                  {% if thirdName and thirdData %}
                    <div class="mt-4 flex items-center gap-3">
                 
      <img class="h-12 w-12 rounded-full bg-white ring-1 ring-black/10 p-1"
                           src="https://api.dicebear.com/9.x/avataaars-neutral/svg?seed={{ thirdName|url_encode }}"
                           alt="Avatar {{ thirdName }}" loading="lazy">
                      <div class="min-w-0">
     
                    <div class="font-extrabold text-slate-900 truncate">{{ thirdName }}</div>
                        <div class="mt-0.5 text-xs text-slate-600">
                          <span class="font-semibold">{{ thirdData.moyenne|default('-') }}</span> pts ‚Ä¢
                  
         {{ thirdData.matchs|default('-') }} {{ 'ranking.table.matches'|trans|lower }}
                        </div>
                      </div>
                    </div>

                    <div class="mt-5 h-20 
 rounded-2xl bg-gradient-to-b from-amber-400 to-amber-600 shadow-inner podium-bar podium-bar-3"></div>
                  {% else %}
                    <div class="mt-4 text-sm text-slate-600">{{ 'ranking.podium.no_rank'|trans({'%rank%': 3}) }}</div>
                    <div class="mt-5 h-20 rounded-2xl bg-amber-200/80"></div>
                  {% endif %}
     
            </div>
              </div>

            </div>
          </div>
        {% endif %}
      </div>

      <div class="mt-8 rounded-2xl bg-white/90 shadow-lg ring-1 ring-black/5 backdrop-blur overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200/70">
          <div 
 class="text-sm font-semibold text-slate-900">{{ 'ranking.table.title'|trans }}</div>
          <div class="text-xs text-slate-500">{{ 'ranking.table.subtitle'|trans }}</div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 text-slate-700">
              <tr>
                <th class="px-6 py-4 font-semibold">{{ 'ranking.table.rank'|trans }}</th>
     
            <th class="px-6 py-4 font-semibold">{{ 'ranking.table.team'|trans }}</th>
                <th class="px-6 py-4 font-semibold">{{ 'ranking.table.points'|trans }}</th>
                <th class="px-6 py-4 font-semibold">{{ 'ranking.table.matches'|trans }}</th>
              </tr>
            </thead>

            <tbody class="divide-y divide-slate-200/70">
        
       {% set rank = 0 %}
              {% for equipe, data in classementSafe %}
                {% set rank = rank + 1 %}
                <tr class="hover:bg-slate-50/70 transition table-row-anim">
                  <td class="px-6 py-4 text-slate-600 font-semibold">#{{ rank }}</td>
   
                <td class="px-6 py-4 font-semibold text-slate-900">
                    <div class="flex items-center gap-3">
                      <img class="h-10 w-10 rounded-full bg-white ring-1 ring-black/10 p-1"
                           src="https://api.dicebear.com/9.x/avataaars-neutral/svg?seed={{ equipe|url_encode 
 }}"
                           alt="Avatar {{ equipe }}" loading="lazy">
                      <span class="truncate">{{ equipe }}</span>
                    </div>
                  </td>
      
             <td class="px-6 py-4 text-slate-700">{{ data.moyenne|default('-') }}</td>
                  <td class="px-6 py-4 text-slate-700">{{ data.matchs|default('-') }}</td>
                </tr>
              {% else %}
                <tr>
            
       <td colspan="4" class="px-6 py-10 text-center text-slate-600">
                    {{ 'ranking.table.empty'|trans }}
 </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
  @keyframes floatIn { 0%{opacity:0;transform:translateY(14px) scale(.98)} 100%{opacity:1;transform:translateY(0) scale(1)} }
  .podium-card { animation: floatIn 520ms ease-out both;
 }
  .podium-card:nth-child(1){animation-delay:60ms}
  .podium-card:nth-child(2){animation-delay:120ms}
  .podium-card:nth-child(3){animation-delay:180ms}

  @keyframes barGrow { 0%{transform:scaleY(.25)} 100%{transform:scaleY(1)} }
  .podium-bar{transform-origin:bottom;animation:barGrow 700ms cubic-bezier(.2,.9,.2,1) both}
  .podium-bar-1{animation-delay:180ms}
  .podium-bar-2{animation-delay:240ms}
  .podium-bar-3{animation-delay:300ms}

  .podium-card > div{transition:transform 220ms ease, box-shadow 220ms ease}
  .podium-card > div:hover{transform:translateY(-4px);box-shadow:0 22px 60px rgba(0,0,0,.12)}

  .shine-once{ position:relative;
 overflow:hidden; }
  .shine-once::after{
    content:"";
    position:absolute;
    inset:-60% -80%;
    background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.55) 50%, transparent 65%);
 transform: translateX(-35%) rotate(8deg);
    animation: shineSweep 780ms ease-out both;
    pointer-events:none;
  }
  @keyframes shineSweep{
    0%{opacity:0;
 transform: translateX(-45%) rotate(8deg)}
    10%{opacity:1}
    100%{opacity:0; transform: translateX(45%) rotate(8deg)}
  }

  .trophy-badge{ transform-origin:center;
 }
  .trophy-pop{ animation: trophyPop 520ms cubic-bezier(.2,.9,.2,1) both; }
  @keyframes trophyPop{
    0%{transform:scale(.7) rotate(-10deg);
 filter: drop-shadow(0 0 0 rgba(0,0,0,0));}
    60%{transform:scale(1.15) rotate(8deg); filter: drop-shadow(0 18px 18px rgba(0,0,0,.18));}
    100%{transform:scale(1) rotate(0deg);
 filter: drop-shadow(0 10px 12px rgba(0,0,0,.12));}
  }

  .row-in{ animation: rowIn 520ms ease-out both;
 }
  @keyframes rowIn{
    0%{opacity:0; transform: translateY(8px);}
    100%{opacity:1;
 transform: translateY(0);}
  }

  .confetti-on{ opacity:1 !important; transition: opacity 180ms ease; }
  .confetti-off{ opacity:0 !important;
 transition: opacity 260ms ease; }

  @media (prefers-reduced-motion: reduce){
    .podium-card,.podium-bar,.shine-once::after,.trophy-pop,.row-in{ animation:none !important;
 }
    .podium-card>div{ transition:none !important; }
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const podium = document.getElementById("podiumWrap");
  const cards = Array.from(podium.querySelectorAll(".podium-card > div"));
  cards.forEach((el, i) => {
    setTimeout(() => el.classList.add("shine-once"), 250 + i * 120);

    setTimeout(() => el.classList.remove("shine-once"), 1300 + i * 120);
  });

 
  const champ = document.getElementById("champCard");
  const trophy = champ ? champ.querySelector(".trophy-badge") : null;

  if (trophy) {
    setTimeout(() => trophy.classList.add("trophy-pop"), 500);
    setTimeout(() => trophy.classList.remove("trophy-pop"), 1200);
  }


  const rows = Array.from(document.querySelectorAll(".table-row-anim"));
  rows.forEach((row, i) => {
  
   row.style.willChange = "transform, opacity";
    row.style.animationDelay = (40 * i) + "ms";
    row.classList.add("row-in");
  });


  const canvas = document.getElementById("confettiCanvas");
  if (!canvas || !champ) return;
 const hasChampion = !!champ.querySelector(".podium-bar-1");
  if (!hasChampion) return;

  const ctx = canvas.getContext("2d");
  let W = 0, H = 0;
 function resize() {
    const rect = podium.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    W = Math.max(1, Math.floor(rect.width));
    H = Math.max(1, Math.floor(rect.height));
 canvas.width = Math.floor(W * dpr);
    canvas.height = Math.floor(H * dpr);
    canvas.style.width = W + "px";
    canvas.style.height = H + "px";
 ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  resize();
  window.addEventListener("resize", resize);

  const COLORS = ["#10b981","#22c55e","#34d399","#a3e635","#fbbf24","#60a5fa","#a78bfa","#fb7185","#38bdf8"];
 function rand(min, max){ return Math.random() * (max - min) + min; }

  let particles = [];
 let raf = null;

  function burst(x, y, count = 120) {
    particles = [];
 for (let i = 0; i < count; i++) {
      particles.push({
        x, y,
        vx: rand(-4.5, 4.5),
        vy: rand(-7.5, -2.0),
        g: rand(0.12, 0.22),
        r: rand(0, Math.PI * 2),
        vr: rand(-0.18, 0.18),
        w: rand(5, 10),
        h: rand(6, 14),
    
     life: rand(60, 95),
        color: COLORS[(Math.random() * COLORS.length) | 0],
        alpha: 1
      });
 }

    canvas.classList.remove("confetti-off");
    canvas.classList.add("confetti-on");

    if (raf) cancelAnimationFrame(raf);
    tick();
 }

  function tick() {
    ctx.clearRect(0, 0, W, H);
 particles.forEach(p => {
      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;
      p.r += p.vr;
      p.life -= 1;
      p.alpha = Math.max(0, p.life / 95);

      ctx.save();
      ctx.globalAlpha = p.alpha;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.r);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w / 2, -p.h / 2, 
 p.w, p.h);
      ctx.restore();
    });
 particles = particles.filter(p => p.life > 0 && p.y < H + 40);
 if (particles.length > 0) {
      raf = requestAnimationFrame(tick);
 } else {
      canvas.classList.remove("confetti-on");
      canvas.classList.add("confetti-off");
 }
  }


  setTimeout(() => burst(W * 0.5, 40, 150), 650);
 const rectCenter = () => {
    const rect = champ.getBoundingClientRect();
    const pod = podium.getBoundingClientRect();
 return {
      x: (rect.left - pod.left) + rect.width * 0.5,
      y: (rect.top - pod.top) + rect.height * 0.15
    };
 };

  let cooldown = false;
  function triggerBurst() {
    if (cooldown) return;
    cooldown = true;
 const c = rectCenter();
    burst(c.x, c.y, 120);
    setTimeout(() => cooldown = false, 800);
  }

  champ.addEventListener("mouseenter", triggerBurst);
  champ.addEventListener("click", triggerBurst);
 if (window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
 
    particles = [];
    if (raf) cancelAnimationFrame(raf);
    canvas.classList.add("confetti-off");
  }
});
</script>
{% endblock %}